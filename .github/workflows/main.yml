import requests, base64, socket, ssl, random, re, os
from urllib.parse import urlparse, parse_qs, urlencode, unquote, quote
from concurrent.futures import ThreadPoolExecutor

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØµÙ„ÛŒ
TARGET_COUNT = 50
TIMEOUT = 2.0  # Ø§ÙØ²Ø§ÛŒØ´ Ø§Ù†Ø¯Ú© ØªØ§ÛŒÙ…â€ŒØ§ÙˆØª Ø¨Ø±Ø§ÛŒ Ø¯Ù‚Øª Ø¨ÛŒØ´ØªØ±
EXPORT_DIR = "export"

# Ù…Ù†Ø§Ø¨Ø¹ Ù…Ø¹ØªØ¨Ø± Ùˆ Ù¾Ø±Ø­Ø¬Ù…
SOURCES = [
    "https://raw.githubusercontent.com/barry-far/V2ray-Configs/main/All_Configs_Sub.txt",
    "https://raw.githubusercontent.com/IranianCypherpunks/sub/main/config",
    "https://raw.githubusercontent.com/mahdibland/V2RayAggregator/master/sub/sub_merge.txt",
    "https://raw.githubusercontent.com/LalatinaHub/Mineral/master/result/nodes",
    "https://raw.githubusercontent.com/Saman_Nirumand/V2ray-Configs/main/Splitted-By-Protocol/vless.txt",
    "https://raw.githubusercontent.com/Saman_Nirumand/V2ray-Configs/main/Splitted-By-Protocol/trojan.txt",
    "https://raw.githubusercontent.com/yebekhe/TV2Ray/main/sub/configs"
]

CLEAN_IPS = ["104.16.1.1", "104.17.1.1", "104.18.1.1", "104.19.1.1"]

def decode_base64_if_needed(content):
    """Ø±Ù…Ø²Ú¯Ø´Ø§ÛŒÛŒ Ù…Ø­ØªÙˆØ§ Ø§Ú¯Ø± Ø¨Ù‡ ØµÙˆØ±Øª Base64 Ø¨Ø§Ø´Ø¯"""
    try:
        # Ø­Ø°Ù ÙØ§ØµÙ„Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ
        content = content.strip()
        # Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ù…Ø­ØªÙˆØ§ Ø´Ø¨ÛŒÙ‡ Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø³Øª ÛŒØ§ Base64
        if "://" in content:
            return content
        return base64.b64decode(content + '=' * (-len(content) % 4)).decode('utf-8', errors='ignore')
    except:
        return content

def check_connection(target_ip, port, sni):
    """ØªØ³Øª Ø³Ù„Ø§Ù…Øª Ú©Ø§Ù†ÙÛŒÚ¯ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù„Ø§ÛŒÙ‡ SSL"""
    try:
        context = ssl.create_default_context()
        context.check_hostname = False
        context.verify_mode = ssl.CERT_NONE
        with socket.create_connection((target_ip, int(port)), timeout=TIMEOUT) as sock:
            with context.wrap_socket(sock, server_hostname=sni) as ssock: 
                return True
    except:
        return False

def process_config(conf, index):
    """Ù¾Ø±Ø¯Ø§Ø²Ø´ØŒ Ø§ØµÙ„Ø§Ø­ IP Ùˆ Ù†Ø§Ù…â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯"""
    try:
        conf = unquote(conf).strip()
        parsed = urlparse(conf)
        if parsed.scheme not in ['vless', 'trojan']: return None
        
        # Ø¬Ø¯Ø§ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø¢Ø¯Ø±Ø³
        if "@" not in parsed.netloc: return None
        user_info, host_port = parsed.netloc.split("@", 1)
        original_address, port = host_port.rsplit(":", 1) if ":" in host_port else (host_port, "443")
        
        params = {k: v[0] for k, v in parse_qs(parsed.query).items()}
        actual_sni = params.get('sni', params.get('host', original_address))
        
        # Ø§Ù†ØªØ®Ø§Ø¨ ÛŒÚ© Cloudflare IP ØªÙ…ÛŒØ²
        clean_ip = random.choice(CLEAN_IPS)
        
        if check_connection(clean_ip, port, actual_sni):
            params.update({'sni': actual_sni, 'host': actual_sni})
            # Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ Ú©ÙˆØ¦Ø±ÛŒ
            query_str = urlencode(params)
            
            # ØªØ´Ø®ÛŒØµ Ù†ÙˆØ¹ Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¯Ù‡ÛŒ
            is_reality = "reality" in conf.lower() or params.get('security') == 'reality'
            tag = "Reality" if is_reality else "Safe"
            remark = quote(f"ğŸš€_IRPX_{tag}_{index}")
            
            return f"{parsed.scheme}://{user_info}@{clean_ip}:{port}?{query_str}#{remark}"
    except:
        pass
    return None

def main():
    try:
        if not os.path.exists(EXPORT_DIR):
            os.makedirs(EXPORT_DIR)
            
        all_raw = set()
        print("ğŸ“¥ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ Ø§Ø² Ù…Ù†Ø§Ø¨Ø¹...")
        
        for s in SOURCES:
            try:
                res = requests.get(s, timeout=15).text
                decoded = decode_base64_if_needed(res)
                # Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªÙ…Ø§Ù… Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Vless Ùˆ Trojan
                found = re.findall(r'(?:vless|trojan)://[^\s#\x00-\x1f]+', decoded)
                all_raw.update(found)
            except:
                continue
        
        if not all_raw:
            print("âŒ Ù‡ÛŒÚ† Ú©Ø§Ù†ÙÛŒÚ¯ÛŒ Ø§Ø² Ù…Ù†Ø§Ø¨Ø¹ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯!")
            return False
        
        # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ: Reality Ø¯Ø± Ø§Ø¨ØªØ¯Ø§
        raw_list = list(all_raw)
        random.shuffle(raw_list) # Ø´Ø§ÙÙ„ Ø¨Ø±Ø§ÛŒ ØªÙ†ÙˆØ¹ Ø¯Ø± Ù‡Ø± Ø³Ø§Ø¹Øª
        reality_raw = [c for c in raw_list if "reality" in c.lower()]
        others_raw = [c for c in raw_list if "reality" not in c.lower()]
        sorted_raw = reality_raw + others_raw
        
        print(f"ğŸ“Š Ú©Ù„ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯Ù‡: {len(sorted_raw)} | Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø³Ù„Ø§Ù…Øª...")
        
        final_results = []
        # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª Ø¨Ø§Ù„Ø§ÛŒ ØªØ³Øª
        with ThreadPoolExecutor(max_workers=30) as executor:
            # Ø¨Ø±Ø±Ø³ÛŒ 800 Ù…ÙˆØ±Ø¯ Ø§ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† 50 ØªØ§ÛŒ Ø³Ø§Ù„Ù…
            futures = [executor.submit(process_config, conf, i+1) for i, conf in enumerate(sorted_raw[:800])]
            for future in futures:
                res = future.result()
                if res:
                    final_results.append(res)
                    if len(final_results) >= TARGET_COUNT:
                        break

        if not final_results:
            print("âŒ Ù‡ÛŒÚ† Ú©Ø§Ù†ÙÛŒÚ¯ÛŒ Ø¯Ø± ØªØ³Øª Ø³Ù„Ø§Ù…Øª Ù‚Ø¨ÙˆÙ„ Ù†Ø´Ø¯!")
            return False
            
        # Ø°Ø®ÛŒØ±Ù‡ Ø®Ø±ÙˆØ¬ÛŒâ€ŒÙ‡Ø§
        final_str = "\n".join(final_results)
        b64_content = base64.b64encode(final_str.encode('utf-8')).decode('utf-8')
        
        with open(os.path.join(EXPORT_DIR, "sub.txt"), "w", encoding="utf-8") as f:
            f.write(final_str)
        with open(os.path.join(EXPORT_DIR, "sub_b64.txt"), "w", encoding="utf-8") as f:
            f.write(b64_content)
        with open("count.txt", "w") as f:
            f.write(str(len(final_results)))
            
        print(f"âœ… Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²: {len(final_results)} Ú©Ø§Ù†ÙÛŒÚ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.")
        return True
        
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡: {e}")
        return False

if __name__ == "__main__":
    success = main()
    # Ø§Ú¯Ø± Ø¯Ø± Ù…Ø­ÛŒØ· Ù„ÙˆÚ©Ø§Ù„ ÛŒØ§ Ù¾Ø±ÛŒÙˆÛŒÙˆ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø§ Ø®Ø·Ø§ Ø®Ø§Ø±Ø¬ Ù†Ø´ÙˆØ¯ ØªØ§ Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø¨Ù…Ø§Ù†Ù†Ø¯
    if os.environ.get('GITHUB_ACTIONS'):
        exit(0 if success else 1)
    else:
        print("=== Ù¾Ø§ÛŒØ§Ù† Ø§Ø¬Ø±Ø§ÛŒ ØªØ³ØªÛŒ ===")
